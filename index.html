<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Práctica – RCP y Manejo de la Vía Aérea</title>
    <!-- Google Fonts: Inter para texto general, Poppins para títulos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <!-- TailwindCSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- CSS Personalizado -->
    <style>
        /* Variables CSS para la nueva paleta de colores y tipografías consistentes */
        :root {
            /* Nueva Paleta de Colores */
            --color-light-green: #eafde6;   /* Fondo o acentos sutiles */
            --color-vibrant-green: #88c425; /* Botones primarios, resaltados */
            --color-medium-green: #519548;  /* Elementos secundarios, bordes */
            --color-deep-turquoise: #1b676b;/* Texto, encabezados, acentos principales */

            /* Colores Derivados para UI - Contraste y propósito */
            --color-text-body: #374151; /* Un gris oscuro para texto general */
            --color-text-light: #f9fafb; /* Para texto sobre fondos oscuros */
            --color-border-light: #d1d5db; /* Un gris claro para bordes sutiles */
            --color-feedback-success-bg: #f0fdf4; /* Fondo para mensajes de éxito (ej. resultados) */
            --color-feedback-success-border: #dcfce7; /* Borde para mensajes de éxito */

            /* Tipografías con fallbacks */
            --font-heading: 'Poppins', 'Arial Black', 'Helvetica', sans-serif;
            --font-body: 'Inter', 'Arial', 'Helvetica', sans-serif;
        }

        /* Base styles and custom classes */
        body {
            background: linear-gradient(135deg, var(--color-light-green) 0%, rgba(234, 253, 230, 0.5) 100%);
            color: var(--color-text-body);
            font-family: var(--font-body);
        }

        .font-poppins {
            font-family: var(--font-heading);
        }

        .font-inter {
            font-family: var(--font-body);
        }

        /* General Container */
        .container {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease-in-out;
        }
        
        @media (min-width: 768px) {
            .container {
                padding: 2.5rem;
            }
        }
        
        .container:hover {
            transform: scale(1.005);
            box-shadow: 0 32px 64px -12px rgba(0, 0, 0, 0.35);
        }

        /* Main Heading */
        .text-main-heading {
            color: var(--color-deep-turquoise);
        }

        /* Section Cards (Unified Style) */
        .section-card {
            background-color: var(--color-light-green);
            border: 1px solid var(--color-medium-green);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
        }
        
        @media (min-width: 768px) {
            .section-card {
                padding: 2rem;
            }
        }
        
        .section-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        /* Special style for Results section */
        .section-card.bg-results-card {
            background-color: var(--color-feedback-success-bg);
        }
        .section-card.border-results-border {
            border-color: var(--color-feedback-success-border);
        }

        /* Section Titles */
        .section-title {
            font-size: 1.25rem;
            font-family: var(--font-heading);
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #d1d5db;
            color: var(--color-deep-turquoise);
        }
        
        @media (min-width: 768px) {
            .section-title {
                font-size: 1.5rem;
            }
        }
        
        .section-title span.font-normal {
            color: var(--color-text-body);
        }

        /* Accent heading for specific sections (e.g., initial info) */
        .text-accent-heading {
            color: var(--color-deep-turquoise);
        }

        /* Results section heading and score values */
        .text-results-heading {
            color: var(--color-medium-green);
        }
        .text-score-value {
            color: var(--color-vibrant-green);
        }

        /* Input Labels */
        .input-label {
            display: block;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        /* Input Fields & Selectors */
        .input-field {
            background-color: var(--color-light-green);
            border: 1px solid var(--color-medium-green);
            color: var(--color-text-body);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            appearance: none;
            border-radius: 0.375rem;
            width: 100%;
            padding: 0.625rem 1rem;
            line-height: 1.25;
            transition: all 0.2s ease-in-out;
        }
        
        .input-field::placeholder {
            color: rgba(27, 103, 107, 0.6);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--color-vibrant-green);
            box-shadow: 0 0 0 3px rgba(136, 196, 37, 0.5), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Specific style for select dropdowns for consistency */
        .score-selector {
            background-color: var(--color-light-green);
            border: 1px solid var(--color-medium-green);
            color: var(--color-text-body);
            appearance: none;
            display: block;
            width: 6rem;
            border-radius: 0.375rem;
            padding: 0.625rem 0.75rem;
            padding-right: 2rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath fill='%231b676b' d='M10 12l-4-4h8l-4 4z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 0.8rem 0.8rem;
        }
        
        .score-selector:focus {
            outline: none;
            border-color: var(--color-vibrant-green);
            box-shadow: 0 0 0 3px rgba(136, 196, 37, 0.5), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Buttons */
        .btn-primary {
            background-color: var(--color-vibrant-green);
            color: var(--color-text-light);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            transform: translateY(0);
            font-size: 1.125rem;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #71a91f;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(136, 196, 37, 0.6);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background-color: var(--color-medium-green);
            color: var(--color-text-light);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            transform: translateY(0);
            font-size: 1.125rem;
            border: none;
            cursor: pointer;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: #427e3d;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(81, 149, 72, 0.6);
        }
        
        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .bg-gray-400 {
            background-color: #9ca3af !important;
        }

        .cursor-not-allowed {
            cursor: not-allowed !important;
        }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip-text {
            visibility: hidden;
            width: 240px;
            background-color: var(--color-deep-turquoise);
            color: var(--color-light-green);
            text-align: center;
            border-radius: 8px;
            padding: 10px 12px;
            position: absolute;
            z-index: 10;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-line;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        /* Tooltip arrow */
        .tooltip-text::after {
            content: " ";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: var(--color-deep-turquoise) transparent transparent transparent;
        }

        /* Utility Classes */
        .grid {
            display: grid;
        }
        
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        
        @media (min-width: 768px) {
            .md\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
            .md\:col-span-1 {
                grid-column: span 1 / span 1;
            }
            .md\:flex-row {
                flex-direction: row;
            }
            .md\:items-center {
                align-items: center;
            }
            .md\:w-3\/4 {
                width: 75%;
            }
            .md\:w-1\/4 {
                width: 25%;
            }
            .md\:mb-0 {
                margin-bottom: 0;
            }
        }
        
        .gap-6 {
            gap: 1.5rem;
        }
        
        .gap-4 {
            gap: 1rem;
        }
        
        .space-y-4 > * + * {
            margin-top: 1rem;
        }
        
        .flex {
            display: flex;
        }
        
        .flex-col {
            flex-direction: column;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .justify-center {
            justify-content: center;
        }
        
        .justify-end {
            justify-content: flex-end;
        }
        
        .items-start {
            align-items: flex-start;
        }
        
        .items-center {
            align-items: center;
        }
        
        .border-b {
            border-bottom-width: 1px;
        }
        
        .border-gray-200 {
            border-color: #e5e7eb;
        }
        
        .pb-4 {
            padding-bottom: 1rem;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .mb-8 {
            margin-bottom: 2rem;
        }
        
        .ml-2 {
            margin-left: 0.5rem;
        }
        
        .mr-2 {
            margin-right: 0.5rem;
        }
        
        .last\:border-b-0:last-child {
            border-bottom-width: 0;
        }
        
        .text-lg {
            font-size: 1.125rem;
        }
        
        .text-xl {
            font-size: 1.25rem;
        }
        
        .text-3xl {
            font-size: 1.875rem;
        }
        
        @media (min-width: 768px) {
            .md\:text-xl {
                font-size: 1.25rem;
            }
            .md\:text-5xl {
                font-size: 3rem;
            }
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .font-extrabold {
            font-weight: 800;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-gray-800 {
            color: #1f2937;
        }
        
        .text-gray-600 {
            color: #4b5563;
        }
        
        .text-gray-500 {
            color: #6b7280;
        }
        
        .text-base {
            font-size: 1rem;
        }
        
        .font-normal {
            font-weight: 400;
        }
        
        .tracking-tight {
            letter-spacing: -0.025em;
        }
        
        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }
        
        .max-w-4xl {
            max-width: 56rem;
        }
        
        .bg-white {
            background-color: #ffffff;
        }
        
        .p-4 {
            padding: 1rem;
        }
        
        @media (min-width: 768px) {
            .md\:p-8 {
                padding: 2rem;
            }
        }
        
        .transition-all {
            transition-property: all;
        }
        
        .duration-300 {
            transition-duration: 0.3s;
        }
        
        .ease-in-out {
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Print Styles */
        @media print {
            body {
                background-color: #fff !important;
                margin: 0;
                padding: 0;
                font-family: var(--font-body) !important;
                color: var(--color-text-body) !important;
            }
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                padding: 0.5cm 1cm !important;
                margin: 0 !important;
                transform: none !important;
            }
            h1 {
                font-size: 24pt !important;
                margin-bottom: 1rem !important;
                color: var(--color-deep-turquoise) !important;
                font-family: var(--font-heading) !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            h2.section-title {
                font-size: 16pt !important;
                margin-bottom: 0.8rem !important;
                border-bottom: 1px solid var(--color-border-light) !important;
                padding-bottom: 0.5rem !important;
                color: var(--color-deep-turquoise) !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            section.section-card {
                border: 1px solid var(--color-medium-green) !important;
                padding: 1rem !important;
                margin-bottom: 1rem !important;
                box-shadow: none !important;
                background-color: var(--color-light-green) !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            section.section-card.bg-results-card {
                background-color: var(--color-feedback-success-bg) !important;
            }
            #exportPdfBtn, #saveGoogleSheetsBtn, .tooltip-container .tooltip-text {
                display: none !important;
            }
            .text-main-heading, .text-accent-heading, .text-results-heading {
                color: var(--color-deep-turquoise) !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .text-score-value {
                color: var(--color-vibrant-green) !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }
    </style>
</head>
<body class="bg-gradient-custom font-inter leading-normal tracking-normal p-4 md:p-8 text-gray-800">

    <div class="container mx-auto max-w-4xl bg-white">
        <h1 class="text-3xl md:text-5xl font-poppins font-extrabold text-center text-main-heading mb-8 tracking-tight">
            Evaluación Práctica <br class="md:hidden"> – RCP y Manejo de la Vía Aérea
        </h1>

        <!-- Campos Iniciales -->
        <section class="section-card mb-8">
            <h2 class="section-title text-accent-heading">Datos de la Evaluación</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="evaluationDate" class="input-label">Fecha de evaluación:</label>
                    <input type="date" id="evaluationDate" class="input-field" required>
                </div>
                <div class="md:col-span-1">
                    <label for="residentName" class="input-label">Nombre del residente evaluado:</label>
                    <input type="text" id="residentName" placeholder="Ej: Dr. Juan Pérez" class="input-field" required>
                </div>
                <div class="md:col-span-1">
                    <label for="evaluatorName" class="input-label">Nombre del evaluador:</label>
                    <input type="text" id="evaluatorName" placeholder="Ej: Dra. Ana Gómez" class="input-field" required>
                </div>
            </div>
        </section>

        <!-- Criterios de Evaluación -->
        <section class="section-card mb-8">
            <h2 class="section-title">Rúbrica de Evaluación <span class="text-base text-gray-500 font-normal">(puntos variables por criterio)</span></h2>

            <div id="rubricContainer" class="space-y-4">
                <!-- Criterios se insertarán aquí por JavaScript -->
            </div>
        </section>

        <!-- Resultados Automáticos -->
        <section class="section-card bg-results-card border-results-border mb-8">
            <h2 class="section-title text-results-heading">Resultados de la Evaluación</h2>
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center text-lg md:text-xl">
                <div class="mb-4 md:mb-0">
                    <span class="font-bold text-gray-800">Puntaje Total:</span>
                    <span id="totalScore" class="text-score-value font-extrabold ml-2 text-3xl transition-all duration-300 ease-in-out">0</span>
                    <span class="text-gray-600"> / 100</span>
                </div>
                <div>
                    <span class="font-bold text-gray-800">Calificación Final:</span>
                    <span id="finalGrade" class="text-score-value font-extrabold ml-2 text-3xl transition-all duration-300 ease-in-out">Insuficiente</span>
                </div>
            </div>
        </section>

        <!-- Botones de Acción -->
        <section class="flex flex-col md:flex-row justify-center gap-4">
            <button id="exportPdfBtn" class="btn-primary">
                <i class="fas fa-file-pdf mr-2"></i> Exportar como PDF
            </button>
            <button id="saveGoogleSheetsBtn" class="btn-secondary">
                <i class="fas fa-save mr-2"></i> Guardar en Google Sheets
            </button>
        </section>
    </div>

    <!-- jspdf library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- JavaScript personalizado -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referencias a los elementos del DOM
            const evaluationDateInput = document.getElementById('evaluationDate');
            const residentNameInput = document.getElementById('residentName');
            const evaluatorNameInput = document.getElementById('evaluatorName');
            const rubricContainer = document.getElementById('rubricContainer');
            const totalScoreSpan = document.getElementById('totalScore');
            const finalGradeSpan = document.getElementById('finalGrade');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const saveGoogleSheetsBtn = document.getElementById('saveGoogleSheetsBtn');

            // ** URL DE GOOGLE APPS SCRIPT ACTUALIZADA **
            const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyj9hyVGtlrB_Lb_EyIkzdIQUs8AdLhZhP3vsVK8JUKQWCLYzJ0CirtVRJgYRnlG2A_/exec';

            // Definición de los criterios de evaluación con sus puntajes máximos
            const criteria = [
                { id: 'rcpTechnique', name: 'Técnica de RCP y manejo de vía aérea', maxScore: 15 },
                { id: 'clinicalEvaluation', name: 'Evaluación clínica inicial y diagnóstico', maxScore: 20 },
                { id: 'dataUsage', name: 'Uso de datos complementarios y monitoreo', maxScore: 15 },
                { id: 'communicationLeadership', name: 'Comunicación y liderazgo en el equipo', maxScore: 20 },
                { id: 'ethicalAttitude', name: 'Actitud ética, reflexiva y profesional', maxScore: 15 },
                { id: 'postArrestCare', name: 'Manejo post paro y continuidad clínica', maxScore: 15 }
            ];

            // Calculamos el puntaje máximo posible
            const ACTUAL_MAXIMUM_POSSIBLE_SCORE = criteria.reduce((sum, criterion) => sum + criterion.maxScore, 0);

            // Escala de calificación para el tooltip
            const scoreScaleTooltip = `
Insuficiente (0–4)
Aceptable (5–9)
Bueno (10–14)
Excelente (15–20)
            `.trim();

            // Generar dinámicamente los criterios de evaluación en el HTML
            criteria.forEach(criterion => {
                const criterionDiv = document.createElement('div');
                criterionDiv.className = 'flex flex-col md:flex-row justify-between items-start md:items-center border-b border-gray-200 pb-4 mb-4 last:border-b-0';
                criterionDiv.innerHTML = `
                    <label for="${criterion.id}" class="text-gray-800 text-lg font-medium mb-2 md:mb-0 md:w-3/4">${criterion.name} (${criterion.maxScore} pts máx)</label>
                    <div class="flex items-center space-x-2 md:w-1/4 justify-end">
                        <div class="tooltip-container">
                            <select id="${criterion.id}" class="score-selector">
                                ${Array.from({ length: criterion.maxScore + 1 }, (_, i) => `<option value="${i}">${i}</option>`).join('')}
                            </select>
                            <span class="tooltip-text">${scoreScaleTooltip}</span>
                        </div>
                    </div>
                `;
                rubricContainer.appendChild(criterionDiv);
            });

            // Añadir listeners a los selectores de puntaje
            const scoreSelectors = document.querySelectorAll('.score-selector');
            scoreSelectors.forEach(selector => {
                selector.addEventListener('change', updateTotalScoreAndGrade);
            });

            // Función para calcular y mostrar el puntaje total y la calificación final
            function updateTotalScoreAndGrade() {
                let rawTotalScore = 0;
                scoreSelectors.forEach(selector => {
                    rawTotalScore += parseInt(selector.value, 10);
                });

                // Escalamos el puntaje a un total sobre 100
                const scaledTotalScore = (rawTotalScore / ACTUAL_MAXIMUM_POSSIBLE_SCORE) * 100;
                const displayedScore = Math.round(scaledTotalScore);
                
                totalScoreSpan.textContent = displayedScore;
                finalGradeSpan.textContent = getFinalGrade(displayedScore);
            }

            // Función para determinar la calificación final
            function getFinalGrade(score) {
                if (score >= 90) {
                    return 'Excelente';
                } else if (score >= 70) {
                    return 'Bueno';
                } else if (score >= 40) {
                    return 'Aceptable';
                } else {
                    return 'Insuficiente';
                }
            }

            // Función para validar campos obligatorios
            function validateForm() {
                const requiredInputs = [
                    evaluationDateInput,
                    residentNameInput,
                    evaluatorNameInput
                ];

                for (const input of requiredInputs) {
                    if (!input.value.trim()) {
                        alert('Por favor, complete todos los campos de información inicial (Fecha, Residente, Evaluador).');
                        input.focus();
                        return false;
                    }
                }
                return true;
            }

            // Función para exportar a PDF
            exportPdfBtn.addEventListener('click', () => {
                if (!validateForm()) {
                    return;
                }

                const originalBtnText = exportPdfBtn.innerHTML;
                exportPdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>
